<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ Eldfell Hiking Guestbook</title>
<script src="https://cdn.tailwindcss.com"></script>

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.1/firebase-app.js";
  import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.6.1/firebase-firestore.js";
  import { getAuth, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.6.1/firebase-auth.js";

  // ğŸ”¹ Firebase config â€” replace with yours
  const firebaseConfig = {
    apiKey: "AIzaSyC-BhaB6qY6C_dwnwenaGBAKy9kIz85OaM",
    authDomain: "eldfell-hiking-guestbook.firebaseapp.com",
    projectId: "eldfell-hiking-guestbook",
    storageBucket: "eldfell-hiking-guestbook.firebasestorage.app",
    messagingSenderId: "545567205471",
    appId: "1:545567205471:web:af86156196aecfa987d3ea",
    measurementId: "G-B4YH34R4TH"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  let entries = [];
  let adminMode = false;
  let currentLang = 'en';

  const labels = {
    en: {
      nameRequired: 'Name is required.',
      addEntry: 'Add Entry',
      location: 'ğŸ“ Location: Eldfell',
      addPhoto: 'Add a photo',
      searchPlaceholder: 'Search by name...',
      fullName: 'Your full name',
      notePlaceholder: 'Write a note about your hike...',
      adminEmailPrompt: 'Enter admin email:',
      adminPasswordPrompt: 'Enter admin password:',
      adminSuccess: 'Admin access granted!',
      adminFail: 'Incorrect email or password.',
      confirmDelete: 'Delete this entry?',
      totalEntries: 'Total Entries:',
      todayHikers: "Today's Hikers:"
    },
    is: {
      nameRequired: 'Nafn er nauÃ°synlegt.',
      addEntry: 'BÃ¦ta viÃ° fÃ¦rslu',
      location: 'ğŸ“ StaÃ°setning: Eldfell',
      addPhoto: 'BÃ¦ta viÃ° mynd',
      searchPlaceholder: 'Leita eftir nafni...',
      fullName: 'Fullt nafn Ã¾itt',
      notePlaceholder: 'SkrifaÃ°u athugasemd um gÃ¶nguna...',
      adminEmailPrompt: 'SlÃ¡Ã°u inn stjÃ³rnandanetfang:',
      adminPasswordPrompt: 'SlÃ¡Ã°u inn lykilorÃ° stjÃ³rnanda:',
      adminSuccess: 'AÃ°gangur stjÃ³rnanda veittur!',
      adminFail: 'Rangt netfang eÃ°a lykilorÃ°.',
      confirmDelete: 'EyÃ°a Ã¾essari fÃ¦rslu?',
      totalEntries: 'FjÃ¶ldi fÃ¦rslna:',
      todayHikers: 'GÃ¶ngumenn Ã­ dag:'
    }
  };

  function getLabel(key){ return labels[currentLang][key]; }

  // Compress image for smaller storage
  function compressImage(file, callback) {
    const reader = new FileReader();
    reader.onload = function(e) {
      const img = new Image();
      img.onload = function() {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const MAX_WIDTH = 300;
        const scaleSize = MAX_WIDTH / img.width;
        canvas.width = MAX_WIDTH;
        canvas.height = img.height * scaleSize;
        ctx.drawImage(img,0,0,canvas.width,canvas.height);
        callback(canvas.toDataURL('image/jpeg',0.7));
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  }

  async function handleAddEntry() {
    const name = document.getElementById('name-input').value.trim();
    const note = document.getElementById('note-input').value.trim();
    const photoFile = document.getElementById('photo-input').files[0];
    if(!name){ alert(getLabel('nameRequired')); return; }

    const now = new Date();
    const dateStr = `${String(now.getDate()).padStart(2,'0')}/${String(now.getMonth()+1).padStart(2,'0')}/${now.getFullYear()}`;
    const timeStr = now.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});

    const saveEntry = async (photo) => {
      await addDoc(collection(db,'guestbookEntries'), { name, note, date: dateStr, time: timeStr, photo });
      document.getElementById('name-input').value='';
      document.getElementById('note-input').value='';
      document.getElementById('photo-input').value='';
    }

    if(photoFile) compressImage(photoFile, saveEntry); else saveEntry(null);
  }

  function displayEntries(list){
    const section = document.getElementById('entries');
    section.innerHTML='';
    list.forEach(entry=>{
      const imgHTML = entry.photo?`<img src="${entry.photo}" class="mt-2 w-24 h-24 object-cover rounded cursor-pointer" onclick="showFullscreen('${entry.photo}')">`:'';
      const adminHTML = adminMode?`<div class="flex gap-2 mt-2"><button onclick="deleteEntry('${entry.id}')" class="bg-red-500 text-white px-2 py-1 rounded">ğŸ—‘ Delete</button></div>`:'';
      section.innerHTML+=`
        <div class="bg-white rounded-lg shadow p-4 hover:shadow-md transition">
          <p class="text-sm text-gray-600">${entry.date} - ${entry.time}</p>
          <p class="font-bold">ğŸ‘¤ ${entry.name}</p>
          <p class="mt-1">${entry.note}</p>
          ${imgHTML}
          ${adminHTML}
        </div>
      `;
    });
    document.getElementById('entry-count').innerText=`${getLabel('totalEntries')} ${list.length}`;
    updateTodayCount();
  }

  function showFullscreen(url){
    const overlay = document.createElement('div');
    overlay.className='fullscreen';
    overlay.innerHTML=`<img src='${url}' onclick='document.body.removeChild(this.parentElement)'>`;
    document.body.appendChild(overlay);
  }

  async function fetchEntriesRealtime(){
    onSnapshot(collection(db,'guestbookEntries'), snapshot=>{
      entries = snapshot.docs.map(d=>({id:d.id,...d.data()}));
      displayEntries(entries);
    });
  }

  async function loginAdmin(){
    const email = prompt(getLabel('adminEmailPrompt'));
    const password = prompt(getLabel('adminPasswordPrompt'));
    try{
      const userCredential = await signInWithEmailAndPassword(auth,email,password);
      adminMode = true;
      displayEntries(entries);
      alert(getLabel('adminSuccess'));
    } catch(e){
      alert(getLabel('adminFail'));
    }
  }

  async function deleteEntry(id){
    if(confirm(getLabel('confirmDelete'))){
      await deleteDoc(doc(db,'guestbookEntries',id));
    }
  }

  function handleSearch(){
    const val = document.getElementById('search-input').value.toLowerCase();
    displayEntries(entries.filter(e=>e.name.toLowerCase().includes(val)));
  }

  function filterByDateText(){
    const val = document.getElementById('date-text-filter').value;
    if(!val){ displayEntries(entries); return; }
    const [year, month, day] = val.split('-');
    const formatted = `${day}/${month}/${year}`;
    displayEntries(entries.filter(e=>e.date===formatted));
  }

  function translateLanguage(){
    currentLang = document.getElementById('lang-select').value;
    document.getElementById('title').textContent=currentLang==='is'?'ğŸ GestabÃ³k Eldfells':'ğŸ Eldfell Hiking Guestbook';
    document.getElementById('location-label').textContent = getLabel('location');
    document.getElementById('photo-label').textContent = getLabel('addPhoto');
    document.getElementById('add-button').textContent = getLabel('addEntry');
    document.getElementById('search-input').placeholder = getLabel('searchPlaceholder');
    document.getElementById('name-input').placeholder = getLabel('fullName');
    document.getElementById('note-input').placeholder = getLabel('notePlaceholder');
    displayEntries(entries);
  }

  function getTodayCount(){
    const today = new Date();
    const todayStr = `${String(today.getDate()).padStart(2,'0')}/${String(today.getMonth()+1).padStart(2,'0')}/${today.getFullYear()}`;
    return entries.filter(e=>e.date===todayStr).length;
  }

  function updateTodayCount(){
    document.getElementById('today-count').textContent=`${getLabel('todayHikers')} ${getTodayCount()}`;
  }

  window.onload = ()=>{ fetchEntriesRealtime(); }

</script>

<style>
.fullscreen {
  position: fixed; top:0; left:0; right:0; bottom:0;
  background-color: rgba(0,0,0,0.9);
  display:flex; align-items:center; justify-content:center;
  z-index:9999;
}
.fullscreen img { max-width:90%; max-height:90%; border-radius:12px; }
</style>
</head>
<body class="bg-gray-50 text-gray-900 min-h-screen">
<div class="max-w-2xl mx-auto p-6 space-y-6">
  <div class="flex justify-between items-center">
    <h1 id="title" class="text-3xl font-extrabold text-green-700">ğŸ Eldfell Hiking Guestbook</h1>
    <select id="lang-select" onchange="translateLanguage()" class="p-2 rounded border bg-white">
      <option value="en">English</option>
      <option value="is">Ãslenska</option>
    </select>
  </div>

  <div class="flex justify-between text-sm text-gray-700">
    <p id="entry-count">Total Entries: 0</p>
    <p id="today-count">Today's Hikers: 0</p>
  </div>

  <div class="flex gap-2">
    <input type="date" id="date-text-filter" oninput="filterByDateText()" class="p-2 rounded border bg-white" />
    <input type="text" id="search-input" placeholder="Search by name..." oninput="handleSearch()" class="p-2 rounded border bg-white flex-1" />
  </div>

  <div class="bg-white rounded-lg shadow p-6 space-y-4">
    <p id="location-label" class="text-lg font-semibold text-green-700">ğŸ“ Location: Eldfell</p>
    <input id="name-input" placeholder="Your full name" class="w-full p-3 rounded border" />
    <textarea id="note-input" placeholder="Write a note about your hike..." class="w-full p-3 rounded border"></textarea>
    <label id="photo-label" class="block text-sm font-medium">Add a photo</label>
    <input id="photo-input" type="file" accept="image/*" class="w-full p-2 rounded border" />
    <button id="add-button" onclick="handleAddEntry()" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded">Add Entry</button>
  </div>

  <div id="entries" class="space-y-4"></div>

  <footer class="mt-10 text-center text-sm text-gray-600 border-t border-gray-300 pt-4">
    <p>Visit our store at <a href="https://3dframleidsla.store" target="_blank" class="text-green-600 hover:underline">3dframleidsla.store</a></p>
    <p>Contact us: <a href="mailto:3dframleidsla@gmail.com" class="text-green-600 hover:underline">3dframleidsla@gmail.com</a></p>
  </footer>

  <button onclick="loginAdmin()" class="fixed bottom-6 right-6 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-full shadow-lg">ğŸ” Admin Login</button>
</div>
</body>
</html>
